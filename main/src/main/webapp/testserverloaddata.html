<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="static/jqueryui/jquery-ui.min.css">
</head>
<body>

<label>部门号：</label><input type="text" id="dept" onkeyup="Myfn.autoCompleteUser('#emp',this.value)">
<label>员工：</label><input type="text" id="emp" autocomplete="off"><!-- autocomplete="off"关闭记录之前的输入记录 -->

<script src="static/js/jquery-3.2.0.js"></script>
<script src="static/jqueryui/jquery-ui.js"></script>
<script src="static/spell/py.js"></script>
<script>
var MyData = {
    URL_API:"test.json"
}
var Myfn={
    //过滤用户
    searchUser:function (callBack,deptId,key,label) {
        function isBigEnough(element, index, array) {
            var re = new RegExp(key);
            if (re.test(array[index].spell)){return true;}
            if (re.test(array[index].fullSpelling)){return true;}
            if (array[index][label] && re.test(array[index][label])){return true;}
            return false;
        }
        var cache = "users";
        if(deptId){
            cache = "users"+deptId
        }
        callBack(MyData[cache].filter(isBigEnough));
    },
    // 自动完成用户搜索
    autoCompleteUser:function (domId,deptIdVal) {
        var cache = "users";
        if(deptIdVal){cache = "users"+deptIdVal}
        //如果用户数据没有则从服务器获取一下（把初始化代码放这里，解决发送多次请求的问题）
        if(MyData[cache] == undefined){
            $.ajax({
                type : "GET",
                url : MyData["URL_API"],
                data : {"deptId":deptIdVal},
                dataType : "json",
                success : function (data) {
                    MyData[cache] = Myfn.addSpell($.map(data, function (item) {return {"label": item['label']}}),"label");
                },
                error : function () {alert("请求出现问题！");return;}
            });
        }

        $(domId).autocomplete({
            minLength:0,
            source: function (request, response) {
                var key = request.term.trim().toUpperCase();
                if(deptIdVal){
                    Myfn.searchUser(function (data) {
                        response(data);
                    },deptIdVal,key,"label");
                    return;
                }
                Myfn.searchUser(function (data) {
                    response(data);
                },'',key,"label");
            },
            create: function () {
                $(this).data('ui-autocomplete')._renderItem = function (ul, item) {
                    return $("<li>")
                        .append($("<div>")).text(item.label +  " | " + item.mobil)
                        .appendTo(ul);
                };
            },
            select: function (event, ui) {
                var item = ui.item;
                $(this).val(ui.item.label);
                for (var i in item) {
                    $(this).attr(i, item[i]);
                }
                event.preventDefault();
                $(this).blur();
            }
        }).focus(function (){
            $(this).autocomplete("search");
        });
    },
    /**
     * 给数据添加拼音
     *
     * 传入两个参数，
     *  data：一个json数组
     *  label：中文所在元素的key
     *
     * 返回
     *  在原json数组的每个元素中添加两个字段
     *      spell：大写的首字母
     *      fullSpelling：大写的全拼
     *
     */
    addSpell:function(data,label) {
        $.each(data,function (n,value) {
            value['spell']=pinyin.getCamelChars(value[label]);
            value['fullSpelling']=pinyin.getFullChars(value[label]).toUpperCase();
        });
        return data;
    }
}

    //页面加载时调用一次自动完成来初始化
    Myfn.autoCompleteUser("#emp");
</script>
</body>
</html>